{% load static %} {% load sass_tags %} {% csrf_token %}

{# CSS Variables from Dashboard Theme - All tab colors customizable from Admin #}
<style>
  :root {
    /* Tab Colors from Admin Theme */
    --tab-active-bg: {{ dashboard_theme.tab_active_bg|default:"#1a5f2a" }};
    --tab-active-text: {{ dashboard_theme.tab_active_text|default:"#ffffff" }};
    --tab-inactive-bg: {{ dashboard_theme.tab_inactive_bg|default:"#ffffff" }};
    --tab-inactive-text: {{ dashboard_theme.tab_inactive_text|default:"#1a5f2a" }};
    --tab-border-color: {{ dashboard_theme.tab_border_color|default:"#1a5f2a" }};
    --tab-hover-bg: {{ dashboard_theme.tab_hover_bg|default:"#e8f5e9" }};
    --primary-color: {{ dashboard_theme.primary_color|default:"#1a5f2a" }};
  }
</style>

<style>
  .nav-tabs .nav-link {
    background-color: var(--tab-inactive-bg);
    color: var(--tab-inactive-text);
    border: none;
    transition: all 0.2s ease-in-out;
  }
  .nav-tabs .nav-link:hover {
    background-color: var(--tab-hover-bg);
  }
  .nav-tabs .nav-link.active {
    background-color: var(--tab-active-bg);
    color: var(--tab-active-text) !important;
  }

  /* Tab Styling */
  #dashboard-tabs {
    display: flex;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  #dashboard-tabs button {
    background: var(--tab-inactive-bg);
    color: var(--tab-inactive-text);
    border: 1px solid var(--tab-border-color);
    border-radius: 10px;
    padding: 10px 20px;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  #dashboard-tabs button:hover {
    background: var(--tab-hover-bg);
    color: var(--tab-inactive-text);
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
  }

  #dashboard-tabs button.active {
    background: var(--tab-active-bg) !important;
    color: var(--tab-active-text) !important;
    border-color: var(--tab-active-bg) !important;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
    transform: scale(1.03);
    font-weight: bold;
  }

  .btn-download-excel {
    background: var(--tab-active-bg) !important;
    color: var(--tab-active-text) !important;
    border-color: var(--tab-active-bg) !important;
    box-shadow: 0 3px 6px rgba(0, 0, 0, 0.25);
    transform: scale(1.03);
    font-weight: bold;
  }

  /* ğŸ©µ ØªØ§Ø¨Ø§Øª Ø£ØµØºØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  @media (max-width: 768px) {
    #dashboard-tabs button {
      padding: 8px 14px;
      font-size: 14px;
    }
  }

  /* ØªØºÙ„ÙŠÙ Ø§Ù„Ù€ select Ø¹Ù„Ø´Ø§Ù† Ù†ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´ÙƒÙ„ */
  .custom-select-wrapper {
    position: relative;
    width: 160px;
  }

  /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ù€ dropdown Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
  .custom-select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid #007fa3;
    border-radius: 10px;
    background-color: #fff;
    color: #007fa3;
    font-weight: 600;
    font-size: 15px;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  /* Ø³Ù‡Ù… ØµØºÙŠØ± Ù…Ø®ØµØµ Ø¨Ø¯Ù„ Ø§Ù„Ø³Ù‡Ù… Ø§Ù„Ø¹Ø§Ø¯ÙŠ */
  .custom-select-wrapper::after {
    content: "â–¼";
    font-size: 12px;
    color: #007fa3;
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    pointer-events: none;
    transition: transform 0.3s ease;
  }

  /* ØªØ£Ø«ÙŠØ± hover */
  .custom-select:hover {
    border-color: #0095c8;
    box-shadow: 0 0 8px rgba(0, 127, 163, 0.3);
  }

  /* ØªØ£Ø«ÙŠØ± Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· */
  .custom-select:focus {
    outline: none;
    border-color: #0095c8;
    box-shadow: 0 0 10px rgba(0, 127, 163, 0.4);
  }

  /* Ø­Ø±ÙƒØ© Ø§Ù„Ø³Ù‡Ù… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙØªØ­ */
  .custom-select:focus + .custom-select-wrapper::after {
    transform: translateY(-50%) rotate(180deg);
  }

  /* Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù */
  .upload-btn-small {
    background-color: #9fc0e4;
    color: #000;
    font-weight: 600;
    padding: 7px 16px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 13.5px;
    box-shadow: 0 2px 6px rgba(0, 127, 163, 0.25);
    border: none;
    display: inline-flex;
    align-items: center;
  }

  .upload-btn-small:hover {
    background: linear-gradient(90deg, #009cc7, #007fa3);
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(0, 127, 163, 0.35);
  }

  .upload-btn-small i {
    font-size: 14px;
  }

  .custom-select {
    padding: 6px 10px;
    border: 1.5px solid #007fa3;
    border-radius: 6px;
    color: #007fa3;
    font-weight: 500;
    font-size: 14px;
    background-color: #fff;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .custom-select:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(0, 127, 163, 0.2);
  }

  .custom-select:hover {
    border-color: #009cc7;
  }

  .custom-select-wrapper {
    min-width: 170px;
  }

  /* Ù„Ù„ØªØ¬Ø§ÙˆØ¨ */
  @media (max-width: 768px) {
    .d-flex.flex-wrap.align-items-center.justify-content-end.gap-3.mb-4 {
      justify-content: center !important;
      gap: 10px;
    }
  }

  .custom-select-wrapper {
    min-width: 200px;
  }

  .gap-3 {
    gap: 1rem !important; /* Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ± */
  }
</style>
<!-- Container-fluid starts  -->
<div class="container-fluid mt-5">
  <div class="row">
    <div class="col-md-12 mt-5">
      <div class="card">
        <div
          class="card-header card-no-border pb-0"
          style="display: flex; align-items: center; gap: 12px"
        >
          <!-- ğŸŸ¦ Ø§Ù„Ù„ÙˆØ¬Ùˆ -->
          <img
            src="{% static 'assets/images/tamer_logistics_logo.png' %}"
            alt="Saudi Aramco Logo"
            style="
              height: 48px;
              width: auto;
              margin-top: -15px;
              background: #e8f1fb;
              border-radius: 6px;
              padding: 4px;
              border: 2px solid #e8f1fb;
            "
          />
          <!-- ğŸŸ¦ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù†Øµ -->
          <div>
            <h4
              style="font-size: 20px; font-weight: 800; color: #000; margin: 0"
            >
            Tamer Clerk 
            </h4>
            <p
              class="mt-1 f-m-light"
              style="font-size: 16px; font-weight: 400; color: gray; margin: 0"
            >
              All-Tabs KPI â€” Complete View
            </p>
          </div>
        </div>
        <div class="card-body mb-5">
          {% if not data_is_uploaded %}
          <!-- âœ… Ø£ÙˆÙ„ Ù…Ø±Ø© (Ø±ÙØ¹ Ù…Ù„Ù Excel) -->
<!--          <div class="card shadow-sm p-4 border-0 text-center">-->
<!--            <h5 class="fw-bold mb-3 text-primary">-->
<!--              ğŸ“Š Upload Roche KPI Excel File-->
<!--            </h5>-->
<!--            <form-->
<!--              method="post"-->
<!--              enctype="multipart/form-data"-->
<!--              class="d-inline-block"-->
<!--              id="uploadForm"-->
<!--            >-->
<!--              {% csrf_token %}-->
<!--              <input type="hidden" name="upload_code" id="hidden_upload_code" />-->
<!--              <div class="mb-3">-->
<!--                <label for="excel_file" class="form-label fw-semibold"-->
<!--                  >Select Excel File:</label-->
<!--                >-->
<!--                {{ form.excel_file }}-->
<!--              </div>-->
<!--              <button-->
<!--                type="button"-->
<!--                class="btn btn-primary px-4"-->
<!--                data-bs-toggle="modal"-->
<!--                data-bs-target="#codeModalInitial"-->
<!--              >-->
<!--                Upload & Analyze-->
<!--              </button>-->
<!--            </form>-->
<!--            &lt;!&ndash; ğŸ’¬ Ù…ÙˆØ¯Ø§Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ &ndash;&gt;-->
<!--            <div-->
<!--              class="modal fade"-->
<!--              id="codeModalInitial"-->
<!--              tabindex="-1"-->
<!--              aria-hidden="true"-->
<!--            >-->
<!--              <div class="modal-dialog modal-dialog-centered">-->
<!--                <div class="modal-content">-->
<!--                  <form id="codeForm">-->
<!--                    <div class="modal-header">-->
<!--                      <h5 class="modal-title">Enter Upload Code</h5>-->
<!--                      <button-->
<!--                        type="button"-->
<!--                        class="btn-close"-->
<!--                        data-bs-dismiss="modal"-->
<!--                        aria-label="Close"-->
<!--                      ></button>-->
<!--                    </div>-->
<!--                    <div class="modal-body">-->
<!--                      <input-->
<!--                        type="password"-->
<!--                        id="upload_code"-->
<!--                        maxlength="4"-->
<!--                        class="form-control text-center"-->
<!--                        placeholder="****"-->
<!--                        required-->
<!--                      />-->
<!--                    </div>-->
<!--                    <div class="modal-footer">-->
<!--                      <button type="submit" class="btn btn-primary">-->
<!--                        Confirm-->
<!--                      </button>-->
<!--                    </div>-->
<!--                  </form>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--          </div>-->
          {% else %}
          <!-- âœ… Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª -->
<!--          <div-->
<!--            class="d-flex flex-wrap align-items-center justify-content-end gap-3 mb-4"-->
<!--          >-->
<!--            &lt;!&ndash; Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ù‡Ø± &ndash;&gt;-->
<!--            <div class="d-flex align-items-center">-->
<!--              <div class="custom-select-wrapper">-->
<!--                <select id="month-select" class="custom-select">-->
<!--                  <option value="">&#45;&#45; All Months &#45;&#45;</option>-->
<!--                  {% for m in months %}-->
<!--                  <option value="{{ m }}">{{ m }}</option>-->
<!--                  {% endfor %}-->
<!--                </select>-->
<!--              </div>-->
<!--              &lt;!&ndash; ÙÙ„ØªØ± Ø§Ù„ÙƒÙˆØ§Ø±ØªØ± &ndash;&gt;-->

<!--              &lt;!&ndash; -->
<!--              <div class="custom-select-wrapper">-->
<!--                <select id="quarter-select" class="custom-select">-->
<!--                  <option value="">&#45;&#45; All Quarters &#45;&#45;</option>-->
<!--                  <option value="Q1-2025">Q1 - 2025 (Jan - Feb - Mar)</option>-->
<!--                  <option value="Q2-2025">Q2 - 2025 (Apr - May - Jun)</option>-->
<!--                  <option value="Q3-2025">Q3 - 2025 (Jul - Aug - Sep)</option>-->
<!--                  <option value="Q4-2025">Q4 - 2025 (Oct - Nov - Dec)</option>-->
<!--                </select>-->
<!--              </div>-->
<!--              &ndash;&gt;-->
<!--              <button id="export-excel-btn" class="btn btn-download-excel ms-3">-->
<!--                ğŸ“¥ Download Excel-->
<!--              </button>-->
<!--            </div>-->
<!--            &lt;!&ndash; Ø²Ø± Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù &ndash;&gt;-->
<!--            <button id="uploadBtn" class="upload-btn-small mb-0">-->
<!--              Upload File-->
<!--            </button>-->
<!--            <input-->
<!--              type="file"-->
<!--              id="uploadExcelInput"-->
<!--              name="excel_file"-->
<!--              class="d-none"-->
<!--            />-->
<!--            &lt;!&ndash; Ù…ÙˆØ¯Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø±ÙØ¹ &ndash;&gt;-->
<!--            <div-->
<!--              class="modal fade"-->
<!--              id="codeModal"-->
<!--              tabindex="-1"-->
<!--              aria-hidden="true"-->
<!--            >-->
<!--              <div class="modal-dialog modal-dialog-centered">-->
<!--                <div class="modal-content">-->
<!--                  <form id="codeForm">-->
<!--                    <div class="modal-header">-->
<!--                      <h5 class="modal-title">Enter Upload Code</h5>-->
<!--                      <button-->
<!--                        type="button"-->
<!--                        class="btn-close"-->
<!--                        data-bs-dismiss="modal"-->
<!--                        aria-label="Close"-->
<!--                      ></button>-->
<!--                    </div>-->
<!--                    <div class="modal-body">-->
<!--                      <input-->
<!--                        type="password"-->
<!--                        id="upload_code"-->
<!--                        maxlength="4"-->
<!--                        class="form-control text-center"-->
<!--                        placeholder="****"-->
<!--                        required-->
<!--                      />-->
<!--                    </div>-->
<!--                    <div class="modal-footer">-->
<!--                      <button type="submit" class="btn btn-primary">-->
<!--                        Confirm-->
<!--                      </button>-->
<!--                    </div>-->
<!--                  </form>-->
<!--                </div>-->
<!--              </div>-->
<!--            </div>-->
<!--          </div>-->
          {% if data_is_uploaded %}
          {% include 'components/ui-kits/alert/components/alert.html' %}
          {% endif %}
          <div id="filter-message"></div>
          <!-- ğŸ”¹ Warehouse + Meeting Points -->
          <ul
            class="nav nav-tabs mt-4 justify-content-start"
            id="dashboard-tabs"
            role="tablist"
          >
            <li class="nav-item" role="presentation">
              <button class="nav-link active" data-tab="warehouse">Project Overview</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-tab="recommendation">Progress Overview</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-tab="project tracker">Ideas & Automation overview</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" data-tab="meeting points">Meeting Points & Actions</button>
            </li>
          </ul>
          <!-- ğŸ”¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ø¨Ø§Øª: Warehouse / Recommendation / Meeting Points -->
          <div id="tab-content" class="card p-4 shadow-sm bg-white mt-3">
            {% if active_tab == "warehouse" %}
              {% include 'components/ui-kits/tab-bootstrap/components/warehouse-cards.html' with warehouse_overview=warehouse_overview clerk_interview_rows=clerk_interview_rows %}
            {% elif active_tab == "recommendation" %}
              {% include 'components/ui-kits/tab-bootstrap/components/recommendation-cards.html' with recommendations=recommendations weekly_tracker_rows=weekly_tracker_rows progress_status_rows=progress_status_rows potential_challenges_rows=potential_challenges_rows %}
            {% elif active_tab == "project tracker" %}
              {% include 'components/ui-kits/tab-bootstrap/components/project-tracker-cards.html' with project_tracker_items=project_tracker_items %}
            {% else %}
            <p class="text-muted text-center mb-0">No data available for this tab.</p>
            {% endif %}
          </div>
          <!-- ğŸ”¹ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ§Ø¨Ø§Øª -->
          <div id="cards-section" class="row mt-3"></div>
          <div
            id="quarter-loader"
            class="text-center my-4"
            style="display: none"
          >
            <div
              class="spinner-border text-primary"
              role="status"
              style="width: 3rem; height: 3rem"
            >
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <div id="data-container"></div>

          <!-- Modal ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Meeting Points & Actions -->
          <div class="modal fade" id="meeting-points-password-modal" tabindex="-1" aria-labelledby="meeting-points-password-label" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="meeting-points-password-label">Meeting Points & Actions</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p class="text-muted small mb-3">This section is protected. Enter the password to view.</p>
                  <input type="password" id="meeting-points-password-input" class="form-control" placeholder="Password" autocomplete="off" />
                  <div id="meeting-points-password-error" class="invalid-feedback d-none"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="button" class="btn btn-primary" id="meeting-points-password-submit">Unlock</button>
                </div>
              </div>
            </div>
          </div>

          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Container-fluid Ends-->
{% block scriptcontent %}
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Bootstrap JS (Bundle includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  $(document).ready(function () {
    const uploadBtn = $('#uploadBtn');
    const uploadInput = $('#uploadExcelInput');
    const codeModalEl = document.getElementById('codeModal');
    const codeModal = new bootstrap.Modal(codeModalEl);

    // âœ… Ù„Ù…Ø§ ÙŠØ¶ØºØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø±ÙØ¹
    uploadBtn.on('click', function () {
      uploadInput.click();
    });

    // âœ… Ù„Ù…Ø§ ÙŠØ®ØªØ§Ø± Ù…Ù„Ù
    uploadInput.on('change', function () {
      if (this.files.length > 0) {
        codeModal.show();
      }
    });

    // âœ… Ø¹Ù†Ø¯ ØªØ£ÙƒÙŠØ¯ ÙƒÙˆØ¯ Ø§Ù„Ø±ÙØ¹
    $('#codeForm').on('submit', function (e) {
      e.preventDefault(); // Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
      const code = $('#upload_code').val().trim();

      if (!code) {
        alert('âš ï¸ Please enter the code first');
        return;
      }

      // âœ… Ø£ØºÙ„Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯
      codeModal.hide();

      // âœ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø±
      const file = uploadInput[0].files[0];
      if (!file) {
        alert('âš ï¸ No file selected');
        return;
      }

      // âœ… Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
      console.log('ğŸ“ Selected file:', file.name);
      console.log('ğŸ”‘ Entered code:', code);

      // âœ… Ù…Ø«Ø§Ù„ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ø¨Ø± AJAX
      const formData = new FormData();
      formData.append('excel_file', file);
      formData.append('upload_code', code);

      fetch('{% url 'dashboard:upload_excel' %}', {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
        .then(res => {
          if (!res.ok) {
            return res.json().then(err => Promise.reject(err));
          }
          return res.json();
        })
        .then(data => {
          console.log('âœ… Upload succeeded:', data);
          if (data.error) {
            alert(data.error);
          } else {
            alert(data.message || 'âœ… File uploaded successfully!');
            // Reload the page to show the new data
            window.location.reload();
          }
        })
        .catch(err => {
          console.error('âŒ Upload error:', err);
          const errorMsg = err.error || err.message || 'âŒ An error occurred during upload.';
          alert(errorMsg);
        });
    });
  });
</script>
<script>
  $(document).ready(function () {
    console.log("ğŸš€ Page is ready");

    const csrftoken = document.querySelector(
      "[name=csrfmiddlewaretoken]",
    ).value;
    let selectedTab = "warehouse";
    let selectedQuarter = "";
    const TAB_CACHE_PREFIX = "dashboard_tab_cache";
    const TAB_CACHE_VERSION = "v7_table_style"; // Ø²ÙŠØ¯ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø¹Ù†Ø¯ ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    const TAB_CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

    function buildTabCacheKey(tab, month, quarter) {
      const safeTab = (tab || "all").toLowerCase();
      const safeMonth = month && month !== "" ? month : "all";
      const safeQuarter = quarter && quarter !== "" ? quarter : "all";
      return `${TAB_CACHE_PREFIX}:${TAB_CACHE_VERSION}:${safeTab}:${safeMonth}:${safeQuarter}`;
    }

    function readTabCache(key) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed.timestamp || !parsed.payload) {
          localStorage.removeItem(key);
          return null;
        }
        const isExpired = Date.now() - parsed.timestamp > TAB_CACHE_TTL_MS;
        if (isExpired) {
          localStorage.removeItem(key);
          return null;
        }
        return parsed.payload;
      } catch (err) {
        console.warn("âš ï¸ Failed to read tab cache:", err);
        return null;
      }
    }

    function writeTabCache(key, payload) {
      try {
        localStorage.setItem(
          key,
          JSON.stringify({ timestamp: Date.now(), payload }),
        );
      } catch (err) {
        console.warn("âš ï¸ Failed to write tab cache:", err);
      }
    }

    $("#dashboard-tabs button[data-tab='warehouse']").addClass("active");
    $("#cards-section").hide();

    // ğŸ”¹ Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ±ÙˆØª (Overview)
    function renderCardsHTML(tabCards) {
      return tabCards
        .map((tab) => {
          const targetHtml =
            tab.target_pct !== null && tab.target_pct !== undefined
              ? `<p class="text-danger mb-0" style="opacity:0.6;"><strong>Target:</strong> ${tab.target_pct}%</p>`
              : "";
          return `
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm h-100 border-primary" style="border-width:2px; border-radius:12px;">
          <div class="card-header text-center fw-bold bg-light" style="color:#000; font-size:18px;">
            ${tab.name}
          </div>
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-1">
              <p class="mb-0" style="color: #9084ad !important;"><strong>Hit:</strong> ${tab.hit_pct}%</p>
              ${targetHtml}
            </div>
            <div class="progress" style="height:20px; border-radius:10px; overflow:hidden;">
              <div class="progress-bar" role="progressbar" style="width: ${tab.hit_pct}%; background-color: #9fc0e4;" aria-valuenow="${tab.hit_pct}" aria-valuemin="0" aria-valuemax="100">
                ${tab.hit_pct}%
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
        })
        .join("");
    }

    // ğŸ”¹ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
    function reinitializeScripts(container) {
      if (!container) return;
      const scripts = container.querySelectorAll("script");
      scripts.forEach((oldScript) => {
        const newScript = document.createElement("script");
        Array.from(oldScript.attributes).forEach((attr) =>
          newScript.setAttribute(attr.name, attr.value),
        );
        newScript.text = oldScript.textContent;
        oldScript.parentNode.replaceChild(newScript, oldScript);
      });
    }

    function attachInnerTabListeners(container) {
      if (!container) return;
      const tabTriggers = container.querySelectorAll(
        'button[data-bs-toggle="tab"]',
      );
      tabTriggers.forEach((tab) => {
        tab.addEventListener("shown.bs.tab", function (event) {
          const targetId = event.target.getAttribute("data-bs-target");
          if (!targetId) return;
          const activePane = document.querySelector(targetId);
          if (!activePane) return;

          const canvas = activePane.querySelector("canvas");
          if (canvas && window.chartInstances) {
            const chartInstance = window.chartInstances[canvas.id];
            if (chartInstance) {
              chartInstance.resize();
              chartInstance.update();
            }
          }
        });
      });
    }

    function refreshVisibleCharts(container) {
      if (!container) return;
      let attempts = 0;
      const canvases = () => container.querySelectorAll("canvas");

      const performRefresh = () => {
        if (!window.chartInstances) return;
        let hasRefreshed = false;
        canvases().forEach((canvas) => {
          const chartInstance = window.chartInstances[canvas.id];
          if (chartInstance) {
            chartInstance.resize();
            chartInstance.update("none");
            hasRefreshed = true;
          }
        });
        attempts += 1;
        if (!hasRefreshed && attempts < 5) {
          setTimeout(performRefresh, 250);
        }
      };

      requestAnimationFrame(performRefresh);
    }

    function queueInitialChartRefresh(container) {
      if (!container) return;
      refreshVisibleCharts(container);
      setTimeout(() => refreshVisibleCharts(container), 400);
      setTimeout(() => refreshVisibleCharts(container), 900);
      setTimeout(() => refreshVisibleCharts(container), 1500);
      setTimeout(() => window.dispatchEvent(new Event("resize")), 1600);
    }

    function initInboundShipmentsDataTable(container) {
      if (!container) return;
      const table = container.querySelector("#inbound-shipments-detail-table");
      if (!table || !window.$ || !$.fn.DataTable) return;
      try {
        if (!$.fn.DataTable.isDataTable(table)) {
          $(table).DataTable();
        }
      } catch (e) {
        console.warn("DataTable init:", e);
      }
    }

    document.addEventListener("chart:rendered", function () {
      queueInitialChartRefresh(document.getElementById("tab-content"));
    });

    function handleTabResponse(data, options = {}) {
      const fromCache = options.fromCache || false;
      if (!fromCache) {
        console.log("ğŸ“¦ [DATA RECEIVED]", data);
      } else {
        console.log("âš¡ Rendering cached data for tab:", selectedTab);
      }

      $("#quarter-loader").hide();

      if (data.error) {
        $("#tab-content").html(
          `<div class='alert alert-warning text-center'>${data.error}</div>`,
        );
        $("#cards-section").html("");
        return;
      }

      if (data.require_password) {
        $("#tab-content").html(
          "<p class='text-muted text-center mb-0'>This section is protected. Enter the password in the window below.</p>",
        );
        $("#meeting-points-password-error").addClass("d-none").text("");
        $("#meeting-points-password-input").val("").removeClass("is-invalid");
        $("#meeting-points-password-modal").modal("show");
        return;
      }

      if (selectedTab.toLowerCase() === "overview") {
        if (data.tab_cards && data.tab_cards.length > 0) {
          $("#cards-section")
            .html(`<div class="row">${renderCardsHTML(data.tab_cards)}</div>`)
            .show();
        } else {
          $("#cards-section")
            .html("<p class='text-muted text-center'>âš ï¸ No data available.</p>")
            .show();
        }
        $("#tab-content").html(
          "<div class='text-center text-muted'>ğŸ“Š Overview Tabs</div>",
        );
        return;
      }

      if (selectedTab.toLowerCase() === "all") {
        const tabContent = $("#tab-content");
        if (data.detail_html && data.detail_html.trim() !== "") {
          tabContent.html(data.detail_html).show();
          reinitializeScripts(tabContent[0]);
          attachInnerTabListeners(tabContent[0]);

          // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø§Ø±ØªØ§Øª Ù…Ø¹ delay Ø£Ø·ÙˆÙ„ Ù„Ø¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„ DOM Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
          setTimeout(() => {
            if (window.initOverviewCharts) {
              window.initOverviewCharts("#tab-content");
            }
            queueInitialChartRefresh(tabContent[0]);
          }, 500);

          // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¶Ø§ÙÙŠØ© Ø¨Ø¹Ø¯ delay Ø£Ø·ÙˆÙ„
          setTimeout(() => {
            queueInitialChartRefresh(tabContent[0]);
            window.dispatchEvent(new Event("resize"));
          }, 1500);
        } else {
          tabContent
            .html("<p class='text-muted text-center'>âš ï¸ No data available.</p>")
            .show();
        }
        return;
      }

      if (data.detail_html && data.detail_html.trim() !== "") {
        $("#tab-content").html(data.detail_html).show();
        reinitializeScripts(document.getElementById("tab-content"));
        attachInnerTabListeners(document.getElementById("tab-content"));
        queueInitialChartRefresh(document.getElementById("tab-content"));
        initInboundShipmentsDataTable(document.getElementById("tab-content"));
        if (selectedTab && selectedTab.toLowerCase() === "dashboard") {
          setTimeout(function () {
            if (window.initInboundPendingDonut) {
              window.initInboundPendingDonut();
              window.dispatchEvent(new Event("resize"));
            }
          }, 100);
          setTimeout(function () {
            if (window.initInboundPendingDonut) {
              window.initInboundPendingDonut();
              window.dispatchEvent(new Event("resize"));
            }
          }, 500);
          setTimeout(function () {
            if (window.initInboundPendingDonut) {
              window.initInboundPendingDonut();
              window.dispatchEvent(new Event("resize"));
            }
          }, 1200);
          if (window.initPodsComplianceChart) {
            setTimeout(window.initPodsComplianceChart, 100);
            setTimeout(window.initPodsComplianceChart, 500);
          }
          if (window.initReturnsComplianceChart) {
            setTimeout(window.initReturnsComplianceChart, 100);
            setTimeout(window.initReturnsComplianceChart, 500);
          }
          if (window.initInventoryCapacityChart) {
            setTimeout(window.initInventoryCapacityChart, 100);
            setTimeout(window.initInventoryCapacityChart, 500);
          }
        }
        setTimeout(function () {
          initInboundShipmentsDataTable(document.getElementById("tab-content"));
        }, 300);
        setTimeout(function () {
          initInboundShipmentsDataTable(document.getElementById("tab-content"));
        }, 500);
        setTimeout(function () {
          initInboundShipmentsDataTable(document.getElementById("tab-content"));
        }, 1000);
      } else {
        $("#tab-content").html(
          "<div class='text-center text-muted'>No data available to display.</div>",
        );
      }
    }

    window.getSelectedQuarter = function () {
      return selectedQuarter;
    };

    window.getSelectedMonth = function () {
      return $("#month-select").val() || "";
    };

    function loadTabData() {
      const month = $("#month-select").val() || "";
      const quarter = selectedQuarter || "";
      // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ§Ø´ Ù„ÙƒÙ„ Ø§Ù„ØªØ§Ø¨Ø§Øª: Ø§Ù„Ø¯Ø§ØªØ§ ÙƒÙ„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø¯Ù…Ù† ÙˆÙŠØ¬Ø¨ Ø£Ù† ØªØ¸Ù‡Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙˆØ±Ø§Ù‹
      const cachedPayload = null;

      var ajaxData = { tab: selectedTab, month: month, quarter: quarter };
      if (selectedTab && selectedTab.toLowerCase() === "project tracker") {
        var pt = new URLSearchParams(window.location.search).get("project_type") || "";
        if (pt) ajaxData.project_type = pt;
      }
      $.ajax({
        url: "{% url 'dashboard:upload_excel' %}",
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        data: ajaxData,
        cache: false,
        beforeSend: function () {
          if (quarter) {
            $("#quarter-loader").show();
          }
          $("#tab-content").html(
            "<div class='text-center p-3 text-muted'>â³ Loading data...</div>",
          );
        },
        success: function (data) {
          if (data.require_password) {
            handleTabResponse(data);
            return;
          }
          handleTabResponse(data);
        },
        error: function (err) {
          $("#quarter-loader").hide();
          console.error("âŒ Error while loading data:", err);
          let msg = "âš ï¸ An error occurred while loading data.";
          try {
            const resp = err.responseJSON;
            if (resp && resp.error) msg = resp.error;
          } catch (e) {}
          $("#tab-content").html(
            "<div class='alert alert-danger text-center'>" + msg + "</div>",
          );
        },
      });
    }

    window.loadTabData = loadTabData;
    window.reinitializeScripts = reinitializeScripts;

    // ğŸ”¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¶ØºØ· Ø§Ù„ØªØ§Ø¨
    $("#dashboard-tabs").on("click", "button", function () {
      selectedTab = $(this).data("tab");
      $("#dashboard-tabs button").removeClass("active");
      $(this).addClass("active");

      // ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù‚Ø¨Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
      $("#tab-content").empty();
      $("#cards-section").empty().hide();

      if (selectedTab.toLowerCase() === "all") {
        $("#cards-section").show();
      }
      if (selectedTab.toLowerCase() === "warehouse" || selectedTab.toLowerCase() === "project tracker") {
        $("#cards-section").hide();
      }

      loadTabData();
    });

    $("#quarter-select").on("change", function () {
      selectedQuarter = this.value || "";
      if (selectedQuarter) {
        $("#month-select").val("");
      }
      loadTabData();
    });

    // ğŸ”¹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±
    $("#month-select").on("change", function () {
      if (selectedQuarter) {
        selectedQuarter = "";
        $("#quarter-select").val("");
      }
      // Ù†Ø¬ÙŠØ¨ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
      selectedTab = $(".nav-link.active").data("tab") || "overview";
      loadTabData();
    });

    // ğŸ”¹ Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„: Ù„Ø§ Ù†Ø³ØªØ¯Ø¹ÙŠ AJAX Ù„ØªØ§Ø¨ Warehouse Ù„Ø£Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø£ØªÙ‰ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø§Ù„ÙØ¹Ù„ (ÙƒØ±ÙˆØª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹Ø§Øª)
    if (selectedTab !== "warehouse") {
      loadTabData();
    }

    // ğŸ”¹ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Meeting Points & Actions
    function getCsrfToken() {
      const el = document.querySelector("[name=csrfmiddlewaretoken]");
      return el ? el.value : "";
    }
    $("#meeting-points-password-submit").on("click", function () {
      const input = $("#meeting-points-password-input");
      const errEl = $("#meeting-points-password-error");
      const password = input.val().trim();
      if (!password) {
        errEl.removeClass("d-none").text("Please enter the password");
        input.addClass("is-invalid");
        return;
      }
      errEl.addClass("d-none").text("");
      input.removeClass("is-invalid");
      $.ajax({
        url: "{% url 'dashboard:meeting_points_unlock' %}",
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        data: { password: password, csrfmiddlewaretoken: getCsrfToken() },
        success: function (res) {
          if (res.ok) {
            $("#meeting-points-password-modal").modal("hide");
            loadTabData();
          } else {
            errEl.removeClass("d-none").text(res.message || "Error");
            input.addClass("is-invalid");
          }
        },
        error: function (xhr) {
          let msg = "An error occurred. Please check the password.";
          try {
            const j = xhr.responseJSON;
            if (j && j.message) msg = j.message;
          } catch (e) {}
          errEl.removeClass("d-none").text(msg);
          input.addClass("is-invalid");
        },
      });
    });
    $("#meeting-points-password-input").on("keydown", function (e) {
      if (e.which === 13) {
        e.preventDefault();
        $("#meeting-points-password-submit").click();
      }
    });
  });

  async function loadTab(tabName) {
    const cacheKey = `tab_${tabName}`;
    const cached = localStorage.getItem(cacheKey);

    if (cached) {
      renderTab(JSON.parse(cached));
      console.log("âœ… Loaded from local cache:", tabName);
      return;
    }

    const response = await fetch(`/your-url?tab=${tabName}`, {
      headers: { "X-Requested-With": "XMLHttpRequest" },
    });
    const data = await response.json();

    localStorage.setItem(cacheKey, JSON.stringify(data));
    renderTab(data);
  }
</script>
<!-- Charts Tabs -->
<script>
  function loadChart(tabName, chartId) {
    const ctx = document.getElementById(chartId)?.getContext("2d");
    if (!ctx) return console.warn("âš ï¸ Canvas element not found:", chartId);
    $("#tab-content").empty();
    $("#cards-section").empty();

    $.ajax({
      url: "{% url 'dashboard:upload_excel' %}",
      method: "GET",
      data: { tab: tabName },
      headers: { "X-Requested-With": "XMLHttpRequest" },
      success: function (res) {
        if (!res.chart_data || !res.chart_data.length) {
          console.warn("âš ï¸ No chart data available:", tabName);
          return;
        }

        if (typeof ChartDataLabels !== "undefined")
          Chart.register(ChartDataLabels);
        if (window["chartjs-plugin-annotation"])
          Chart.register(window["chartjs-plugin-annotation"]);

        const chartData = res.chart_data.map((kpi) => {
          let type = (kpi.type || "").toLowerCase();
          if (type === "column") type = "bar";
          if (kpi.name?.toLowerCase().includes("target")) type = "line";
          return { ...kpi, type };
        });

        const labels = chartData[0]?.dataPoints.map((dp) => dp.label) || [];
        const datasets = chartData.map((kpi) => ({
          label: kpi.name,
          data: kpi.dataPoints.map((dp) => Number(dp.y)),
          type: kpi.type || "bar",
          backgroundColor: kpi.color || "#36a2eb",
          borderRadius: 6,
        }));

        new Chart(ctx, {
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: "top" },
              datalabels: {
                display: true,
                color: "#000",
                formatter: (v) => v + "%",
                anchor: "end",
                align: "top",
              },
            },
            scales: {
              y: { beginAtZero: true, ticks: { callback: (v) => v + "%" } },
            },
          },
        });
      },
      error: function (err) {
        console.error("âŒ Error while loading chart:", err);
      },
    });
  }
</script>
<script>
  document
    .getElementById("month-select")
    .addEventListener("change", function () {
      const selectedMonth = this.value;
      const container = document.getElementById("data-container");

      if (!selectedMonth) {
        container.innerHTML = "";
        return;
      }

      fetch("{% url 'dashboard:upload_excel' %}?month=" + selectedMonth, {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.error) {
            container.innerHTML = `<p class="text-danger">${data.error}</p>`;
            return;
          }
          container.innerHTML = data.html;
        })
        .catch((err) => console.error("âŒ Fetch Month Error:", err));
    });
</script>
<script>
  document
    .getElementById("export-excel-btn")
    .addEventListener("click", function () {
      const month = document.getElementById("month-select").value || "";
      const quarter = document.getElementById("quarter-select").value || "";
      const params = new URLSearchParams();
      params.set("action", "export_excel");
      if (month) params.set("month", month);
      if (quarter) params.set("quarter", quarter);
      window.location.href = `?${params.toString()}`;
    });
</script>

{% endblock %}
