{% load static %}
{# Project Tracker — نفس ديزاين الكروت والجدول زي باقي الداشبورد، مع الداتا الجديدة (month_sections) #}
<style>
  .project-tracker-section {
    margin-bottom: 2rem;
  }
  .project-tracker-card {
    background: #ffffff;
    border: 1px solid #eef1f4;
    border-radius: 16px;
    box-shadow: 0 4px 18px rgba(16, 24, 40, 0.05);
    transition: all 0.25s ease;
    overflow: hidden;
  }
  .project-tracker-card:hover {
    box-shadow: 0 10px 28px rgba(16, 24, 40, 0.08);
  }
  .project-tracker-card .pt-header {
    padding: 1.2rem 1.5rem;
    border-bottom: 1px solid #f0f2f5;
    background: linear-gradient(90deg, #fafbfc, #ffffff);
  }
  .project-tracker-card .pt-header .pt-title {
    font-size: 1.1rem;
    font-weight: 700;
    letter-spacing: 0.3px;
    color: #2c2f33;
    margin: 0;
  }
  .project-tracker-card.this-month .pt-header .pt-title { color: #2e7d32; }
  .project-tracker-card.last-month .pt-header .pt-title { color: #f57c00; }
  .project-tracker-card .pt-body {
    padding: 1rem 1.25rem;
  }
  .project-tracker-card .pt-table {
    width: 100%;
    font-size: 0.875rem;
    border-collapse: separate;
    border-spacing: 0 6px;
  }
  .project-tracker-card .pt-table th {
    padding: 0.5rem 0.75rem;
    background: #f8fafc;
    color: #344054;
    font-weight: 600;
    font-size: 13px;
  }
  .project-tracker-card .pt-table tbody tr {
    background: #fafbfd;
  }
  .project-tracker-card .pt-table tbody tr:hover {
    background-color: #f9fbff;
    transition: 0.2s;
  }
  .project-tracker-card .pt-table td {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #f1f3f6;
    font-size: 13px;
  }
  .project-tracker-card .pt-table .progress-row td {
    background: #f8fafc;
    padding: 0.5rem 0.75rem;
    border-bottom: none;
    vertical-align: middle;
  }
  .project-tracker-card .pt-table .progress-cell {
    min-width: 120px;
  }
  .project-tracker-card .pt-table .progress-bar-wrap {
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    display: flex;
  }
  .project-tracker-card .pt-table .progress-bar-wrap span {
    height: 100%;
    display: block;
  }
  .project-tracker-card .pt-table .status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 500;
    color: #fff;
  }
  .project-tracker-card .pt-table .status-done { background: #2e7d32; }
  .project-tracker-card .pt-table .status-working_on_it { background: #f57c00; }
  .project-tracker-card .pt-table .status-stuck { background: #d32f2f; }
  .project-tracker-card .pt-table .status-empty { background: #9aa3ad; color: #fff; }
  .project-tracker-card .pt-table .pt-col-description { min-width: 220px; width: 28%; }
  /* Scroll for tables with many rows */
  .project-tracker-card .pt-table-wrap {
    max-height: 420px;
    overflow-y: auto;
    overflow-x: auto;
  }
  .project-tracker-card .pt-table thead th {
    position: sticky;
    top: 0;
    z-index: 2;
    background: #f8fafc;
    box-shadow: 0 1px 0 #e2e8f0;
  }
  /* Launch % circular charts above table */
  .pt-launch-charts {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1.25rem;
    align-items: flex-start;
  }
  .pt-launch-chart-wrap {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 100px;
  }
  .pt-launch-chart-wrap .pt-chart-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #344054;
    margin-top: 0.35rem;
    text-align: center;
  }
  .pt-launch-chart-circle {
    width: 90px;
    height: 90px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1rem;
    color: #2c2f33;
    background: conic-gradient(#2e7d32 0deg calc(var(--pct, 0) * 3.6deg), #e2e8f0 calc(var(--pct, 0) * 3.6deg) 360deg);
  }
  .pt-launch-chart-circle .pt-chart-inner {
    width: 62px;
    height: 62px;
    border-radius: 50%;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 0 0 3px #fff;
  }
</style>

<div class="project-tracker-container">
  {% if project_tracker_items.month_sections %}
  <div class="pt-launch-charts">
    {% for section in project_tracker_items.month_sections %}
    <div class="pt-launch-chart-wrap">
      <div class="pt-launch-chart-circle" style="--pct: {{ section.launch_done_pct|default:0 }};">
        <div class="pt-chart-inner">{{ section.launch_done_pct|default:0 }}%</div>
      </div>
      <span class="pt-chart-label">{{ section.label }}</span>
    </div>
    {% endfor %}
  </div>
  {% endif %}
  <div class="project-tracker-filters mb-3 d-flex flex-wrap align-items-center gap-3">
    <div>
      <label for="projectTypeFilter" class="me-2" style="font-weight: 600;">Project Type:</label>
      <select id="projectTypeFilter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
        <option value="" {% if not project_tracker_items.current_project_type %}selected{% endif %}>All</option>
        <option value="idea" {% if project_tracker_items.current_project_type == 'idea' %}selected{% endif %}>Idea</option>
        <option value="automation" {% if project_tracker_items.current_project_type == 'automation' %}selected{% endif %}>Automation</option>
      </select>
    </div>
    <div>
      <label for="launchFilter" class="me-2" style="font-weight: 600;">Launch:</label>
      <select id="launchFilter" class="form-select form-select-sm" style="width: auto; display: inline-block;">
        <option value="">All</option>
        <option value="done">Done</option>
      </select>
    </div>
  </div>
  {% for section in project_tracker_items.month_sections %}
  <div class="project-tracker-section {{ section.css_class }}">
    <div class="project-tracker-card {{ section.css_class }}">
      <div class="pt-header">
        <h3 class="pt-title">{{ section.label }}</h3>
      </div>
      <div class="pt-body">
        <div class="pt-table-wrap">
        <table class="pt-table">
          <thead>
            <tr>
              <th>Business</th>
              <th>Department</th>
              <th class="pt-col-description">Description</th>
              <th>Project Type</th>
              <th>Start Date</th>
              <th>Brainstorming</th>
              <th>Development</th>
              <th>Launch</th>
              <th>Test Deadline</th>
              <th>Employee Name</th>
              <th>Remarks</th>
            </tr>
          </thead>
          <tbody>
            {% for item in section.items %}
            <tr class="pt-data-row" data-launch="{{ item.launch_status|default:'' }}">
              <td>{{ item.company|default:"—" }}</td>
              <td>{{ item.department|default:"—" }}</td>
              <td class="pt-col-description">{{ item.description }}</td>
              <td>{{ item.project_type_display|default:"—" }}</td>
              <td>{{ item.start_date_display }}</td>
              <td>
                <span class="status-badge {% if item.brainstorming_status %}status-{{ item.brainstorming_status }}{% else %}status-empty{% endif %}">
                  {{ item.brainstorming_display|default:"—" }}
                </span>
              </td>
              <td>
                <span class="status-badge {% if item.execution_status %}status-{{ item.execution_status }}{% else %}status-empty{% endif %}">
                  {{ item.execution_display|default:"—" }}
                </span>
              </td>
              <td>
                <span class="status-badge {% if item.launch_status %}status-{{ item.launch_status }}{% else %}status-empty{% endif %}">
                  {{ item.launch_display|default:"—" }}
                </span>
              </td>
              <td>{{ item.end_date_display|default:"—" }}</td>
              <td>{{ item.person_name }}</td>
              <td>{{ item.remarks|default:"—" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="11" class="text-muted text-center">No items for this month.</td></tr>
            {% endfor %}
            {% if section.items %}
            <tr class="progress-row">
              <td colspan="5" style="background:#f8fafc; border-bottom:none;"></td>
              <td class="progress-cell">
                <div class="progress-bar-wrap">
                  <span style="width:{{ section.progress.brainstorming.done_pct }}%; background:#2e7d32;" title="Done"></span>
                  <span style="width:{{ section.progress.brainstorming.working_on_it_pct }}%; background:#f57c00;" title="Working on it"></span>
                  <span style="width:{{ section.progress.brainstorming.stuck_pct }}%; background:#d32f2f;" title="Stuck"></span>
                  <span style="width:{{ section.progress.brainstorming.empty_pct }}%; background:#9aa3ad;" title="Empty"></span>
                </div>
              </td>
              <td class="progress-cell">
                <div class="progress-bar-wrap">
                  <span style="width:{{ section.progress.execution.done_pct }}%; background:#2e7d32;"></span>
                  <span style="width:{{ section.progress.execution.working_on_it_pct }}%; background:#f57c00;"></span>
                  <span style="width:{{ section.progress.execution.stuck_pct }}%; background:#d32f2f;"></span>
                  <span style="width:{{ section.progress.execution.empty_pct }}%; background:#9aa3ad;"></span>
                </div>
              </td>
              <td class="progress-cell">
                <div class="progress-bar-wrap">
                  <span style="width:{{ section.progress.launch.done_pct }}%; background:#2e7d32;"></span>
                  <span style="width:{{ section.progress.launch.working_on_it_pct }}%; background:#f57c00;"></span>
                  <span style="width:{{ section.progress.launch.stuck_pct }}%; background:#d32f2f;"></span>
                  <span style="width:{{ section.progress.launch.empty_pct }}%; background:#9aa3ad;"></span>
                </div>
              </td>
              <td style="background:#f8fafc; border-bottom:none;"></td>
              <td style="background:#f8fafc; border-bottom:none;"></td>
              <td style="background:#f8fafc; border-bottom:none;"></td>
            </tr>
            {% endif %}
          </tbody>
        </table>
        </div>
      </div>
    </div>
  </div>
  {% empty %}
  <p class="text-muted text-center mb-0">No project tracker data. Add items from Admin.</p>
  {% endfor %}
</div>
<script>
(function() {
  var projectTypeSel = document.getElementById("projectTypeFilter");
  if (projectTypeSel) {
    projectTypeSel.addEventListener("change", function() {
      var value = this.value;
      var params = new URLSearchParams(window.location.search);
      params.set("tab", "project tracker");
      if (value) params.set("project_type", value);
      else params.delete("project_type");
      var newUrl = window.location.pathname + "?" + params.toString();
      history.replaceState({}, "", newUrl);
      if (typeof window.loadTabData === "function") {
        window.loadTabData();
      }
    });
  }

  var launchSel = document.getElementById("launchFilter");
  if (launchSel) {
    function applyLaunchFilter() {
      var showDoneOnly = launchSel.value === "done";
      document.querySelectorAll(".pt-data-row").forEach(function(row) {
        var launch = (row.getAttribute("data-launch") || "").toLowerCase();
        var show = !showDoneOnly || launch === "done";
        row.style.display = show ? "" : "none";
      });
    }
    launchSel.addEventListener("change", applyLaunchFilter);
    applyLaunchFilter();
  }
})();
</script>
